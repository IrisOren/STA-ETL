---
title: "Edinburgh Tool Library - 2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}

library(tidyverse)
library(ggrepel)
library(plotly)
library(lubridate)
```

[Edinburgh Tool Library](https://edinburghtoollibrary.org.uk/)

```{r echo=FALSE, message=FALSE, warning=FALSE}
usage <- read_csv("raw_data/usage-export jan-dec 2019.csv") %>% 
  janitor::clean_names()

categories <- read_csv("raw_data/categories copy.csv") %>% 
  janitor::clean_names()

loans <- read_csv("raw_data/loans-export jan-dec 2019.csv") %>% 
  janitor::clean_names() %>%
  mutate(due_date = as.Date(due_date, format = "%d/%m/%Y"),
         checked_out = as.POSIXct(checked_out, format = "%d/%m/%Y %H:%M"),
         checked_in = as.POSIXct(checked_in, format = "%d/%m/%Y %H:%M")
         ) %>% 
  left_join(categories, by = "item_id") %>% 
  mutate(month = month(checked_out, label = T))
```


### Most common tools borrowed at certain times of the year?
```{r echo=FALSE, message=FALSE, warning=FALSE}
loans %>% 
  mutate(month = month(checked_out, label = T)) %>% 
  group_by(month, item_name) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count)) %>% 
  arrange(month, desc(count)) %>% 
  left_join(categories, by = c("item_name" = "name")) %>% 
  select(month, item_name, categories, count) %>% 
  slice_max(1) %>% 
  knitr::kable(col.names = c("Month", "Tool", "Category", "Loans")) 
  
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
loans %>%
  group_by(month, categories) %>% 
  drop_na(categories) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = month, y = count, col = categories, group = categories)) +
  geom_line() +
  labs(x = "Month", 
       y = "Count",
       col = "Category",
       title = "2019 Loans by Category"
       ) +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_brewer(palette="Paired")
```

### How we can use a "cost per tool" to show money saved for members?

```{r message=FALSE, warning=FALSE, include=FALSE}
savings <- loans %>%
  filter(is.na(renewal)) %>% 
  group_by(user_id) %>% 
  summarise(savings = sum(replacement_cost)) %>% 
  drop_na(savings)
```

##### Average Savings: £`r mean(savings$savings)`


##### Max savings: £`r max(savings$savings)`



##### User `r savings %>% arrange(desc(savings)) %>% top_n(1) %>% select(user_id)` saved the most by using ETL with `r loans %>% filter(user_id == 711) %>% count()` loans in 2019. 



### How we can use a "CO2 per tool" to show a carbon saving?

### Interesting ways to show usage patterns by time, and by type of tool?
